{"version":3,"file":"header.js","sources":["../../src/blocks/header/header.js"],"sourcesContent":["import { fetchPlaceholders, getMetadata } from '../../scripts/aem.js';\nimport { loadFragment } from '../fragment/fragment.js';\nimport './header.css';\n\n// media query match that indicates mobile/tablet width\nconst isDesktop = window.matchMedia('(min-width: 900px)');\n\nfunction closeOnEscape(e) {\n  if (e.code === 'Escape') {\n    const nav = document.getElementById('nav');\n    const navSections = nav.querySelector('.nav-sections');\n    const navSectionExpanded = navSections.querySelector('[aria-expanded=\"true\"]');\n    if (navSectionExpanded && isDesktop.matches) {\n      // eslint-disable-next-line no-use-before-define\n      toggleAllNavSections(navSections);\n      navSectionExpanded.focus();\n    } else if (!isDesktop.matches) {\n      // eslint-disable-next-line no-use-before-define\n      toggleMenu(nav, navSections);\n      nav.querySelector('button').focus();\n    }\n  }\n}\n\nfunction closeOnFocusLost(e) {\n  const nav = e.currentTarget;\n  if (!nav.contains(e.relatedTarget)) {\n    const navSections = nav.querySelector('.nav-sections');\n    const navSectionExpanded = navSections.querySelector('[aria-expanded=\"true\"]');\n    if (navSectionExpanded && isDesktop.matches) {\n      // eslint-disable-next-line no-use-before-define\n      toggleAllNavSections(navSections, false);\n    } else if (!isDesktop.matches) {\n      // eslint-disable-next-line no-use-before-define\n      toggleMenu(nav, navSections, false);\n    }\n  }\n}\n\nfunction openOnKeydown(e) {\n  const focused = document.activeElement;\n  const isNavDrop = focused.className === 'nav-drop';\n  if (isNavDrop && (e.code === 'Enter' || e.code === 'Space')) {\n    const dropExpanded = focused.getAttribute('aria-expanded') === 'true';\n    // eslint-disable-next-line no-use-before-define\n    toggleAllNavSections(focused.closest('.nav-sections'));\n    focused.setAttribute('aria-expanded', dropExpanded ? 'false' : 'true');\n  }\n}\n\nfunction focusNavSection() {\n  document.activeElement.addEventListener('keydown', openOnKeydown);\n}\n\n/**\n * Toggles all nav sections\n * @param {Element} sections The container element\n * @param {Boolean} expanded Whether the element should be expanded or collapsed\n */\nfunction toggleAllNavSections(sections, expanded = false) {\n  sections.querySelectorAll('.nav-sections .default-content-wrapper > ul > li').forEach((section) => {\n    section.setAttribute('aria-expanded', expanded);\n  });\n}\n\n/**\n * Toggles the entire nav\n * @param {Element} nav The container element\n * @param {Element} navSections The nav sections within the container element\n * @param {*} forceExpanded Optional param to force nav expand behavior when not null\n */\nfunction toggleMenu(nav, navSections, forceExpanded = null) {\n  const expanded = forceExpanded !== null ? !forceExpanded : nav.getAttribute('aria-expanded') === 'true';\n  const button = nav.querySelector('.nav-hamburger button');\n  document.body.style.overflowY = (expanded || isDesktop.matches) ? '' : 'hidden';\n  nav.setAttribute('aria-expanded', expanded ? 'false' : 'true');\n  toggleAllNavSections(navSections, expanded || isDesktop.matches ? 'false' : 'true');\n  button.setAttribute('aria-label', expanded ? 'Open navigation' : 'Close navigation');\n  // enable nav dropdown keyboard accessibility\n  const navDrops = navSections.querySelectorAll('.nav-drop');\n  if (isDesktop.matches) {\n    navDrops.forEach((drop) => {\n      if (!drop.hasAttribute('tabindex')) {\n        drop.setAttribute('tabindex', 0);\n        drop.addEventListener('focus', focusNavSection);\n      }\n    });\n  } else {\n    navDrops.forEach((drop) => {\n      drop.removeAttribute('tabindex');\n      drop.removeEventListener('focus', focusNavSection);\n    });\n  }\n\n  // enable menu collapse on escape keypress\n  if (!expanded || isDesktop.matches) {\n    // collapse menu on escape press\n    window.addEventListener('keydown', closeOnEscape);\n    // collapse menu on focus lost\n    nav.addEventListener('focusout', closeOnFocusLost);\n  } else {\n    window.removeEventListener('keydown', closeOnEscape);\n    nav.removeEventListener('focusout', closeOnFocusLost);\n  }\n}\n\nfunction getDirectTextContent(menuItem) {\n  const menuLink = menuItem.querySelector(':scope > a');\n  if (menuLink) {\n    return menuLink.textContent.trim();\n  }\n  return Array.from(menuItem.childNodes)\n    .filter((n) => n.nodeType === Node.TEXT_NODE)\n    .map((n) => n.textContent)\n    .join(' ');\n}\n\nasync function buildBreadcrumbsFromNavTree(nav, currentUrl) {\n  const crumbs = [];\n\n  const homeUrl = document.querySelector('.nav-brand a[href]').href;\n\n  let menuItem = Array.from(nav.querySelectorAll('a')).find((a) => a.href === currentUrl);\n  if (menuItem) {\n    do {\n      const link = menuItem.querySelector(':scope > a');\n      crumbs.unshift({ title: getDirectTextContent(menuItem), url: link ? link.href : null });\n      menuItem = menuItem.closest('ul')?.closest('li');\n    } while (menuItem);\n  } else if (currentUrl !== homeUrl) {\n    crumbs.unshift({ title: getMetadata('og:title'), url: currentUrl });\n  }\n\n  const placeholders = await fetchPlaceholders();\n  const homePlaceholder = placeholders.breadcrumbsHomeLabel || 'Home';\n\n  crumbs.unshift({ title: homePlaceholder, url: homeUrl });\n\n  // last link is current page and should not be linked\n  if (crumbs.length > 1) {\n    crumbs[crumbs.length - 1].url = null;\n  }\n  crumbs[crumbs.length - 1]['aria-current'] = 'page';\n  return crumbs;\n}\n\nasync function buildBreadcrumbs() {\n  const breadcrumbs = document.createElement('nav');\n  breadcrumbs.className = 'breadcrumbs';\n\n  const crumbs = await buildBreadcrumbsFromNavTree(document.querySelector('.nav-sections'), document.location.href);\n\n  const ol = document.createElement('ol');\n  ol.append(...crumbs.map((item) => {\n    const li = document.createElement('li');\n    if (item['aria-current']) li.setAttribute('aria-current', item['aria-current']);\n    if (item.url) {\n      const a = document.createElement('a');\n      a.href = item.url;\n      a.textContent = item.title;\n      li.append(a);\n    } else {\n      li.textContent = item.title;\n    }\n    return li;\n  }));\n\n  breadcrumbs.append(ol);\n  return breadcrumbs;\n}\n\n/**\n * loads and decorates the header, mainly the nav\n * @param {Element} block The header block element\n */\nexport default async function decorate(block) {\n  // load nav as fragment\n  const navMeta = getMetadata('nav');\n  const navPath = navMeta ? new URL(navMeta, window.location).pathname : '/nav-da';\n  const fragment = await loadFragment(navPath);\n\n  // decorate nav DOM\n  block.textContent = '';\n  const nav = document.createElement('nav');\n  nav.id = 'nav';\n  while (fragment.firstElementChild) nav.append(fragment.firstElementChild);\n\n  const classes = ['brand', 'sections', 'tools'];\n  classes.forEach((c, i) => {\n    const section = nav.children[i];\n    if (section) section.classList.add(`nav-${c}`);\n  });\n\n  const navBrand = nav.querySelector('.nav-brand');\n  const brandLink = navBrand.querySelector('.button');\n  if (brandLink) {\n    brandLink.className = '';\n    brandLink.closest('.button-container').className = '';\n  }\n\n  const navSections = nav.querySelector('.nav-sections');\n  if (navSections) {\n    navSections.querySelectorAll(':scope .default-content-wrapper > ul > li').forEach((navSection) => {\n      if (navSection.querySelector('ul')) navSection.classList.add('nav-drop');\n      navSection.addEventListener('click', (event) => {\n        if (isDesktop.matches) {\n          event.stopPropagation();\n          const expanded = navSection.getAttribute('aria-expanded') === 'true';\n          toggleAllNavSections(navSections);\n          navSection.setAttribute('aria-expanded', expanded ? 'false' : 'true');\n        }\n      });\n    });\n  }\n\n  const navTools = nav.querySelector('.nav-tools');\n  if (navTools) {\n    const search = navTools.querySelector('a[href*=\"search\"]');\n    if (search && search.textContent === '') {\n      search.setAttribute('aria-label', 'Search');\n    }\n  }\n\n  // hamburger for mobile\n  const hamburger = document.createElement('div');\n  hamburger.classList.add('nav-hamburger');\n  hamburger.innerHTML = `<button type=\"button\" aria-controls=\"nav\" aria-label=\"Open navigation\">\n      <span class=\"nav-hamburger-icon\"></span>\n    </button>`;\n  hamburger.addEventListener('click', () => toggleMenu(nav, navSections));\n  nav.prepend(hamburger);\n  nav.setAttribute('aria-expanded', 'false');\n  // prevent mobile nav behavior on window resize\n  toggleMenu(nav, navSections, isDesktop.matches);\n  isDesktop.addEventListener('change', () => toggleMenu(nav, navSections, isDesktop.matches));\n\n  const navWrapper = document.createElement('div');\n  navWrapper.className = 'nav-wrapper';\n  navWrapper.append(nav);\n  block.append(navWrapper);\n\n  if (getMetadata('breadcrumbs').toLowerCase() === 'true') {\n    navWrapper.append(await buildBreadcrumbs());\n  }\n}\n"],"names":["isDesktop","closeOnEscape","e","nav","navSections","navSectionExpanded","toggleAllNavSections","toggleMenu","closeOnFocusLost","openOnKeydown","focused","dropExpanded","focusNavSection","sections","expanded","section","forceExpanded","button","navDrops","drop","getDirectTextContent","menuItem","menuLink","n","buildBreadcrumbsFromNavTree","currentUrl","crumbs","homeUrl","a","link","getMetadata","homePlaceholder","fetchPlaceholders","buildBreadcrumbs","breadcrumbs","ol","item","li","decorate","block","navMeta","navPath","fragment","loadFragment","c","i","brandLink","navSection","event","navTools","search","hamburger","navWrapper"],"mappings":"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"}