{"version":3,"file":"search.js","sources":["../../src/blocks/search/search.js"],"sourcesContent":["import {\n  createOptimizedPicture,\n  decorateIcons,\n  fetchPlaceholders,\n} from '../../scripts/aem.js';\n\nconst searchParams = new URLSearchParams(window.location.search);\n\nfunction findNextHeading(el) {\n  let preceedingEl = el.parentElement.previousElement || el.parentElement.parentElement;\n  let h = 'H2';\n  while (preceedingEl) {\n    const lastHeading = [...preceedingEl.querySelectorAll('h1, h2, h3, h4, h5, h6')].pop();\n    if (lastHeading) {\n      const level = parseInt(lastHeading.nodeName[1], 10);\n      h = level < 6 ? `H${level + 1}` : 'H6';\n      preceedingEl = false;\n    } else {\n      preceedingEl = preceedingEl.previousElement || preceedingEl.parentElement;\n    }\n  }\n  return h;\n}\n\nfunction highlightTextElements(terms, elements) {\n  elements.forEach((element) => {\n    if (!element || !element.textContent) return;\n\n    const matches = [];\n    const { textContent } = element;\n    terms.forEach((term) => {\n      let start = 0;\n      let offset = textContent.toLowerCase().indexOf(term.toLowerCase(), start);\n      while (offset >= 0) {\n        matches.push({ offset, term: textContent.substring(offset, offset + term.length) });\n        start = offset + term.length;\n        offset = textContent.toLowerCase().indexOf(term.toLowerCase(), start);\n      }\n    });\n\n    if (!matches.length) {\n      return;\n    }\n\n    matches.sort((a, b) => a.offset - b.offset);\n    let currentIndex = 0;\n    const fragment = matches.reduce((acc, { offset, term }) => {\n      if (offset < currentIndex) return acc;\n      const textBefore = textContent.substring(currentIndex, offset);\n      if (textBefore) {\n        acc.appendChild(document.createTextNode(textBefore));\n      }\n      const markedTerm = document.createElement('mark');\n      markedTerm.textContent = term;\n      acc.appendChild(markedTerm);\n      currentIndex = offset + term.length;\n      return acc;\n    }, document.createDocumentFragment());\n    const textAfter = textContent.substring(currentIndex);\n    if (textAfter) {\n      fragment.appendChild(document.createTextNode(textAfter));\n    }\n    element.innerHTML = '';\n    element.appendChild(fragment);\n  });\n}\n\nexport async function fetchData(source) {\n  const response = await fetch(source);\n  if (!response.ok) {\n    // eslint-disable-next-line no-console\n    console.error('error loading API response', response);\n    return null;\n  }\n\n  const json = await response.json();\n  if (!json) {\n    // eslint-disable-next-line no-console\n    console.error('empty API response', source);\n    return null;\n  }\n\n  return json.data;\n}\n\nfunction renderResult(result, searchTerms, titleTag) {\n  const li = document.createElement('li');\n  const a = document.createElement('a');\n  a.href = result.path;\n  if (result.image) {\n    const wrapper = document.createElement('div');\n    wrapper.className = 'search-result-image';\n    const pic = createOptimizedPicture(result.image, '', false, [{ width: '375' }]);\n    wrapper.append(pic);\n    a.append(wrapper);\n  }\n  if (result.title) {\n    const title = document.createElement(titleTag);\n    title.className = 'search-result-title';\n    const link = document.createElement('a');\n    link.href = result.path;\n    link.textContent = result.title;\n    highlightTextElements(searchTerms, [link]);\n    title.append(link);\n    a.append(title);\n  }\n  if (result.description) {\n    const description = document.createElement('p');\n    description.textContent = result.description;\n    highlightTextElements(searchTerms, [description]);\n    a.append(description);\n  }\n  li.append(a);\n  return li;\n}\n\nfunction clearSearchResults(block) {\n  const searchResults = block.querySelector('.search-results');\n  searchResults.innerHTML = '';\n}\n\nfunction clearSearch(block) {\n  clearSearchResults(block);\n  if (window.history.replaceState) {\n    const url = new URL(window.location.href);\n    url.search = '';\n    searchParams.delete('q');\n    window.history.replaceState({}, '', url.toString());\n  }\n}\n\nasync function renderResults(block, config, filteredData, searchTerms) {\n  clearSearchResults(block);\n  const searchResults = block.querySelector('.search-results');\n  const headingTag = searchResults.dataset.h;\n\n  if (filteredData.length) {\n    searchResults.classList.remove('no-results');\n    filteredData.forEach((result) => {\n      const li = renderResult(result, searchTerms, headingTag);\n      searchResults.append(li);\n    });\n  } else {\n    const noResultsMessage = document.createElement('li');\n    searchResults.classList.add('no-results');\n    noResultsMessage.textContent = config.placeholders.searchNoResults || 'No results found.';\n    searchResults.append(noResultsMessage);\n  }\n}\n\nfunction compareFound(hit1, hit2) {\n  return hit1.minIdx - hit2.minIdx;\n}\n\nfunction filterData(searchTerms, data) {\n  const foundInHeader = [];\n  const foundInMeta = [];\n\n  data.forEach((result) => {\n    let minIdx = -1;\n\n    searchTerms.forEach((term) => {\n      const idx = (result.header || result.title).toLowerCase().indexOf(term);\n      if (idx < 0) return;\n      if (minIdx < idx) minIdx = idx;\n    });\n\n    if (minIdx >= 0) {\n      foundInHeader.push({ minIdx, result });\n      return;\n    }\n\n    const metaContents = `${result.title} ${result.description} ${result.path.split('/').pop()}`.toLowerCase();\n    searchTerms.forEach((term) => {\n      const idx = metaContents.indexOf(term);\n      if (idx < 0) return;\n      if (minIdx < idx) minIdx = idx;\n    });\n\n    if (minIdx >= 0) {\n      foundInMeta.push({ minIdx, result });\n    }\n  });\n\n  return [\n    ...foundInHeader.sort(compareFound),\n    ...foundInMeta.sort(compareFound),\n  ].map((item) => item.result);\n}\n\nasync function handleSearch(e, block, config) {\n  const searchValue = e.target.value;\n  searchParams.set('q', searchValue);\n  if (window.history.replaceState) {\n    const url = new URL(window.location.href);\n    url.search = searchParams.toString();\n    window.history.replaceState({}, '', url.toString());\n  }\n\n  if (searchValue.length < 3) {\n    clearSearch(block);\n    return;\n  }\n  const searchTerms = searchValue.toLowerCase().split(/\\s+/).filter((term) => !!term);\n\n  const data = await fetchData(config.source);\n  const filteredData = filterData(searchTerms, data);\n  await renderResults(block, config, filteredData, searchTerms);\n}\n\nfunction searchResultsContainer(block) {\n  const results = document.createElement('ul');\n  results.className = 'search-results';\n  results.dataset.h = findNextHeading(block);\n  return results;\n}\n\nfunction searchInput(block, config) {\n  const input = document.createElement('input');\n  input.setAttribute('type', 'search');\n  input.className = 'search-input';\n\n  const searchPlaceholder = config.placeholders.searchPlaceholder || 'Search...';\n  input.placeholder = searchPlaceholder;\n  input.setAttribute('aria-label', searchPlaceholder);\n\n  input.addEventListener('input', (e) => {\n    handleSearch(e, block, config);\n  });\n\n  input.addEventListener('keyup', (e) => { if (e.code === 'Escape') { clearSearch(block); } });\n\n  return input;\n}\n\nfunction searchIcon() {\n  const icon = document.createElement('span');\n  icon.classList.add('icon', 'icon-search');\n  return icon;\n}\n\nfunction searchBox(block, config) {\n  const box = document.createElement('div');\n  box.classList.add('search-box');\n  box.append(\n    searchIcon(),\n    searchInput(block, config),\n  );\n\n  return box;\n}\n\nexport default async function decorate(block) {\n  const placeholders = await fetchPlaceholders();\n  const source = block.querySelector('a[href]') ? block.querySelector('a[href]').href : '/query-index.json';\n  block.innerHTML = '';\n  block.append(\n    searchBox(block, { source, placeholders }),\n    searchResultsContainer(block),\n  );\n\n  if (searchParams.get('q')) {\n    const input = block.querySelector('input');\n    input.value = searchParams.get('q');\n    input.dispatchEvent(new Event('input'));\n  }\n\n  decorateIcons(block);\n}\n"],"names":["searchParams","findNextHeading","el","preceedingEl","h","lastHeading","level","highlightTextElements","terms","elements","element","matches","textContent","term","start","offset","a","b","currentIndex","fragment","acc","textBefore","markedTerm","textAfter","fetchData","source","response","json","renderResult","result","searchTerms","titleTag","li","wrapper","pic","createOptimizedPicture","title","link","description","clearSearchResults","block","searchResults","clearSearch","url","renderResults","config","filteredData","headingTag","noResultsMessage","compareFound","hit1","hit2","filterData","data","foundInHeader","foundInMeta","minIdx","idx","metaContents","item","handleSearch","searchValue","searchResultsContainer","results","searchInput","input","searchPlaceholder","e","searchIcon","icon","searchBox","box","decorate","placeholders","fetchPlaceholders","decorateIcons"],"mappings":"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"}