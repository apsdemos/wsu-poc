{"version":3,"file":"video.js","sources":["../../src/blocks/video/video.js"],"sourcesContent":["/*\n * Video Block\n * Show a video referenced by a link\n * https://www.hlx.live/developer/block-collection/video\n */\n\nconst prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');\n\nfunction embedYoutube(url, autoplay, background) {\n  const usp = new URLSearchParams(url.search);\n  let suffix = '';\n  if (background || autoplay) {\n    const suffixParams = {\n      autoplay: autoplay ? '1' : '0',\n      mute: background ? '1' : '0',\n      controls: background ? '0' : '1',\n      disablekb: background ? '1' : '0',\n      loop: background ? '1' : '0',\n      playsinline: background ? '1' : '0',\n    };\n    suffix = `&${Object.entries(suffixParams).map(([k, v]) => `${k}=${encodeURIComponent(v)}`).join('&')}`;\n  }\n  let vid = usp.get('v') ? encodeURIComponent(usp.get('v')) : '';\n  const embed = url.pathname;\n  if (url.origin.includes('youtu.be')) {\n    [, vid] = url.pathname.split('/');\n  }\n\n  const temp = document.createElement('div');\n  temp.innerHTML = `<div style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;\">\n      <iframe src=\"https://www.youtube.com${vid ? `/embed/${vid}?rel=0&v=${vid}${suffix}` : embed}\" style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" \n      allow=\"autoplay; fullscreen; picture-in-picture; encrypted-media; accelerometer; gyroscope; picture-in-picture\" allowfullscreen=\"\" scrolling=\"no\" title=\"Content from Youtube\" loading=\"lazy\"></iframe>\n    </div>`;\n  return temp.children.item(0);\n}\n\nfunction embedVimeo(url, autoplay, background) {\n  const [, video] = url.pathname.split('/');\n  let suffix = '';\n  if (background || autoplay) {\n    const suffixParams = {\n      autoplay: autoplay ? '1' : '0',\n      background: background ? '1' : '0',\n    };\n    suffix = `?${Object.entries(suffixParams).map(([k, v]) => `${k}=${encodeURIComponent(v)}`).join('&')}`;\n  }\n  const temp = document.createElement('div');\n  temp.innerHTML = `<div style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;\">\n      <iframe src=\"https://player.vimeo.com/video/${video}${suffix}\" \n      style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" \n      frameborder=\"0\" allow=\"autoplay; fullscreen; picture-in-picture\" allowfullscreen  \n      title=\"Content from Vimeo\" loading=\"lazy\"></iframe>\n    </div>`;\n  return temp.children.item(0);\n}\n\nfunction getVideoElement(source, autoplay, background) {\n  const video = document.createElement('video');\n  video.setAttribute('controls', '');\n  if (autoplay) video.setAttribute('autoplay', '');\n  if (background) {\n    video.setAttribute('loop', '');\n    video.setAttribute('playsinline', '');\n    video.removeAttribute('controls');\n    video.addEventListener('canplay', () => {\n      video.muted = true;\n      if (autoplay) video.play();\n    });\n  }\n\n  const sourceEl = document.createElement('source');\n  sourceEl.setAttribute('src', source);\n  sourceEl.setAttribute('type', `video/${source.split('.').pop()}`);\n  video.append(sourceEl);\n\n  return video;\n}\n\nconst loadVideoEmbed = (block, link, autoplay, background) => {\n  if (block.dataset.embedLoaded === 'true') {\n    return;\n  }\n  const url = new URL(link);\n\n  const isYoutube = link.includes('youtube') || link.includes('youtu.be');\n  const isVimeo = link.includes('vimeo');\n\n  if (isYoutube) {\n    const embedWrapper = embedYoutube(url, autoplay, background);\n    block.append(embedWrapper);\n    embedWrapper.querySelector('iframe').addEventListener('load', () => {\n      block.dataset.embedLoaded = true;\n    });\n  } else if (isVimeo) {\n    const embedWrapper = embedVimeo(url, autoplay, background);\n    block.append(embedWrapper);\n    embedWrapper.querySelector('iframe').addEventListener('load', () => {\n      block.dataset.embedLoaded = true;\n    });\n  } else {\n    const videoEl = getVideoElement(link, autoplay, background);\n    block.append(videoEl);\n    videoEl.addEventListener('canplay', () => {\n      block.dataset.embedLoaded = true;\n    });\n  }\n};\n\nexport default async function decorate(block) {\n  const placeholder = block.querySelector('picture');\n  const link = block.querySelector('a').href;\n  block.textContent = '';\n  block.dataset.embedLoaded = false;\n\n  const autoplay = block.classList.contains('autoplay');\n  if (placeholder) {\n    block.classList.add('placeholder');\n    const wrapper = document.createElement('div');\n    wrapper.className = 'video-placeholder';\n    wrapper.append(placeholder);\n\n    if (!autoplay) {\n      wrapper.insertAdjacentHTML(\n        'beforeend',\n        '<div class=\"video-placeholder-play\"><button type=\"button\" title=\"Play\"></button></div>',\n      );\n      wrapper.addEventListener('click', () => {\n        wrapper.remove();\n        loadVideoEmbed(block, link, true, false);\n      });\n    }\n    block.append(wrapper);\n  }\n\n  if (!placeholder || autoplay) {\n    const observer = new IntersectionObserver((entries) => {\n      if (entries.some((e) => e.isIntersecting)) {\n        observer.disconnect();\n        const playOnLoad = autoplay && !prefersReducedMotion.matches;\n        loadVideoEmbed(block, link, playOnLoad, autoplay);\n      }\n    });\n    observer.observe(block);\n  }\n}\n"],"names":["prefersReducedMotion","embedYoutube","url","autoplay","background","usp","suffix","k","v","vid","embed","temp","embedVimeo","video","getVideoElement","source","sourceEl","loadVideoEmbed","block","link","isYoutube","isVimeo","embedWrapper","videoEl","decorate","placeholder","wrapper","observer","entries","e","playOnLoad"],"mappings":"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"}