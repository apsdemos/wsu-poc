{"version":3,"file":"form.js","sources":["../../src/blocks/form/form.js"],"sourcesContent":["import createField from './form-fields.js';\n\nasync function createForm(formHref, submitHref) {\n  const { pathname } = new URL(formHref);\n  const resp = await fetch(pathname);\n  const json = await resp.json();\n\n  const form = document.createElement('form');\n  form.dataset.action = submitHref;\n\n  const fields = await Promise.all(json.data.map((fd) => createField(fd, form)));\n  fields.forEach((field) => {\n    if (field) {\n      form.append(field);\n    }\n  });\n\n  // group fields into fieldsets\n  const fieldsets = form.querySelectorAll('fieldset');\n  fieldsets.forEach((fieldset) => {\n    form.querySelectorAll(`[data-fieldset=\"${fieldset.name}\"`).forEach((field) => {\n      fieldset.append(field);\n    });\n  });\n\n  return form;\n}\n\nfunction generatePayload(form) {\n  const payload = {};\n\n  [...form.elements].forEach((field) => {\n    if (field.name && field.type !== 'submit' && !field.disabled) {\n      if (field.type === 'radio') {\n        if (field.checked) payload[field.name] = field.value;\n      } else if (field.type === 'checkbox') {\n        if (field.checked) payload[field.name] = payload[field.name] ? `${payload[field.name]},${field.value}` : field.value;\n      } else {\n        payload[field.name] = field.value;\n      }\n    }\n  });\n  return payload;\n}\n\nasync function handleSubmit(form) {\n  if (form.getAttribute('data-submitting') === 'true') return;\n\n  const submit = form.querySelector('button[type=\"submit\"]');\n  try {\n    form.setAttribute('data-submitting', 'true');\n    submit.disabled = true;\n\n    // create payload\n    const payload = generatePayload(form);\n    const response = await fetch(form.dataset.action, {\n      method: 'POST',\n      body: JSON.stringify({ data: payload }),\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n    if (response.ok) {\n      if (form.dataset.confirmation) {\n        window.location.href = form.dataset.confirmation;\n      }\n    } else {\n      const error = await response.text();\n      throw new Error(error);\n    }\n  } catch (e) {\n    // eslint-disable-next-line no-console\n    console.error(e);\n  } finally {\n    form.setAttribute('data-submitting', 'false');\n    submit.disabled = false;\n  }\n}\n\nexport default async function decorate(block) {\n  const links = [...block.querySelectorAll('a')].map((a) => a.href);\n  const formLink = links.find((link) => link.startsWith(window.location.origin) && link.endsWith('.json'));\n  const submitLink = links.find((link) => link !== formLink);\n  if (!formLink || !submitLink) return;\n\n  const form = await createForm(formLink, submitLink);\n  block.replaceChildren(form);\n\n  form.addEventListener('submit', (e) => {\n    e.preventDefault();\n    const valid = form.checkValidity();\n    if (valid) {\n      handleSubmit(form);\n    } else {\n      const firstInvalidEl = form.querySelector(':invalid:not(fieldset)');\n      if (firstInvalidEl) {\n        firstInvalidEl.focus();\n        firstInvalidEl.scrollIntoView({ behavior: 'smooth' });\n      }\n    }\n  });\n}\n"],"names":["createForm","formHref","submitHref","pathname","json","form","fd","createField","field","fieldset","generatePayload","payload","handleSubmit","submit","response","error","e","decorate","block","links","formLink","link","submitLink","firstInvalidEl"],"mappings":"mFAEA,eAAeA,EAAWC,EAAUC,EAAY,CAC9C,KAAM,CAAE,SAAAC,CAAQ,EAAK,IAAI,IAAIF,CAAQ,EAE/BG,EAAO,MADA,MAAM,MAAMD,CAAQ,GACT,KAAM,EAExBE,EAAO,SAAS,cAAc,MAAM,EAC1C,OAAAA,EAAK,QAAQ,OAASH,GAEP,MAAM,QAAQ,IAAIE,EAAK,KAAK,IAAKE,GAAOC,EAAYD,EAAID,CAAI,CAAC,CAAC,GACtE,QAASG,GAAU,CACpBA,GACFH,EAAK,OAAOG,CAAK,CAEvB,CAAG,EAGiBH,EAAK,iBAAiB,UAAU,EACxC,QAASI,GAAa,CAC9BJ,EAAK,iBAAiB,mBAAmBI,EAAS,IAAI,GAAG,EAAE,QAASD,GAAU,CAC5EC,EAAS,OAAOD,CAAK,CAC3B,CAAK,CACL,CAAG,EAEMH,CACT,CAEA,SAASK,EAAgBL,EAAM,CAC7B,MAAMM,EAAU,CAAE,EAElB,OAAC,GAAGN,EAAK,QAAQ,EAAE,QAASG,GAAU,CAChCA,EAAM,MAAQA,EAAM,OAAS,UAAY,CAACA,EAAM,WAC9CA,EAAM,OAAS,QACbA,EAAM,UAASG,EAAQH,EAAM,IAAI,EAAIA,EAAM,OACtCA,EAAM,OAAS,WACpBA,EAAM,UAASG,EAAQH,EAAM,IAAI,EAAIG,EAAQH,EAAM,IAAI,EAAI,GAAGG,EAAQH,EAAM,IAAI,CAAC,IAAIA,EAAM,KAAK,GAAKA,EAAM,OAE/GG,EAAQH,EAAM,IAAI,EAAIA,EAAM,MAGpC,CAAG,EACMG,CACT,CAEA,eAAeC,EAAaP,EAAM,CAChC,GAAIA,EAAK,aAAa,iBAAiB,IAAM,OAAQ,OAErD,MAAMQ,EAASR,EAAK,cAAc,uBAAuB,EACzD,GAAI,CACFA,EAAK,aAAa,kBAAmB,MAAM,EAC3CQ,EAAO,SAAW,GAGlB,MAAMF,EAAUD,EAAgBL,CAAI,EAC9BS,EAAW,MAAM,MAAMT,EAAK,QAAQ,OAAQ,CAChD,OAAQ,OACR,KAAM,KAAK,UAAU,CAAE,KAAMM,CAAO,CAAE,EACtC,QAAS,CACP,eAAgB,kBACjB,CACP,CAAK,EACD,GAAIG,EAAS,GACPT,EAAK,QAAQ,eACf,OAAO,SAAS,KAAOA,EAAK,QAAQ,kBAEjC,CACL,MAAMU,EAAQ,MAAMD,EAAS,KAAM,EACnC,MAAM,IAAI,MAAMC,CAAK,CAC3B,CACG,OAAQC,EAAG,CAEV,QAAQ,MAAMA,CAAC,CACnB,QAAY,CACRX,EAAK,aAAa,kBAAmB,OAAO,EAC5CQ,EAAO,SAAW,EACtB,CACA,CAEe,eAAeI,EAASC,EAAO,CAC5C,MAAMC,EAAQ,CAAC,GAAGD,EAAM,iBAAiB,GAAG,CAAC,EAAE,IAAK,GAAM,EAAE,IAAI,EAC1DE,EAAWD,EAAM,KAAME,GAASA,EAAK,WAAW,OAAO,SAAS,MAAM,GAAKA,EAAK,SAAS,OAAO,CAAC,EACjGC,EAAaH,EAAM,KAAME,GAASA,IAASD,CAAQ,EACzD,GAAI,CAACA,GAAY,CAACE,EAAY,OAE9B,MAAMjB,EAAO,MAAML,EAAWoB,EAAUE,CAAU,EAClDJ,EAAM,gBAAgBb,CAAI,EAE1BA,EAAK,iBAAiB,SAAWW,GAAM,CAGrC,GAFAA,EAAE,eAAgB,EACJX,EAAK,cAAe,EAEhCO,EAAaP,CAAI,MACZ,CACL,MAAMkB,EAAiBlB,EAAK,cAAc,wBAAwB,EAC9DkB,IACFA,EAAe,MAAO,EACtBA,EAAe,eAAe,CAAE,SAAU,QAAQ,CAAE,EAE5D,CACA,CAAG,CACH"}